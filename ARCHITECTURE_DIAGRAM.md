# Диаграмма архитектуры Forest Mafia Bot

## Общая схема архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                    FOREST MAFIA BOT                            │
│                     (Clean Architecture)                       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   PRESENTATION  │    │   APPLICATION   │    │    DOMAIN       │
│     LAYER       │    │     LAYER       │    │     LAYER       │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Command       │    │ • GameService   │    │ • Game          │
│   Handlers      │    │ • UserService   │    │ • Player        │
│ • Callback      │    │ • VotingService │    │ • GameStats     │
│   Handlers      │    │ • Factories     │    │ • Value Objects │
│ • Bot Main      │    │ • BotService    │    │ • Repositories  │
│                 │    │                 │    │ • Role Actions  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────────┐
│                INFRASTRUCTURE LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│ • Repository Implementations  │ • Database Adapters            │
│ • Configuration              │ • External APIs                │
│ • Logging                    │ • File System                  │
└─────────────────────────────────────────────────────────────────┘
```

## Детальная схема слоев

### 1. Domain Layer (Доменный слой)

```
┌─────────────────────────────────────────────────────────────────┐
│                        DOMAIN LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   ENTITIES      │    │  VALUE OBJECTS  │    │ REPOSITORIES │ │
│  ├─────────────────┤    ├─────────────────┤    ├──────────────┤ │
│  │ • Game          │    │ • UserId        │    │ • GameRepo   │ │
│  │ • Player        │    │ • ChatId        │    │ • PlayerRepo │ │
│  │ • GameStats     │    │ • Username      │    │ • UserRepo   │ │
│  │                 │    │ • Supplies      │    │ • EventRepo  │ │
│  │                 │    │ • GameDuration  │    │ • StatsRepo  │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  ROLE ACTIONS                              │ │
│  ├─────────────────────────────────────────────────────────────┤ │
│  │ • WolfAction    • FoxAction    • MoleAction                │ │
│  │ • BeaverAction  • HareAction   • RoleActionFactory         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Application Layer (Слой приложения)

```
┌─────────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │    SERVICES     │    │    FACTORIES    │    │   HANDLERS   │ │
│  ├─────────────────┤    ├─────────────────┤    ├──────────────┤ │
│  │ • GameService   │    │ • GameFactory   │    │ • Command    │ │
│  │ • UserService   │    │ • PlayerFactory │    │   Handlers   │ │
│  │ • VotingService │    │ • ValueObject   │    │ • Callback   │ │
│  │ • RoleAssignment│    │   Factory       │    │   Handlers   │ │
│  │                 │    │ • StatsFactory  │    │ • Admin      │ │
│  └─────────────────┘    └─────────────────┘    │   Handlers   │ │
│                                                 └──────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    BOT SERVICE                             │ │
│  ├─────────────────────────────────────────────────────────────┤ │
│  │ • Game Management    • User Management                     │ │
│  │ • Voting Processing  • Event Logging                       │ │
│  │ • Authorization      • Configuration                       │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Infrastructure Layer (Инфраструктурный слой)

```
┌─────────────────────────────────────────────────────────────────┐
│                 INFRASTRUCTURE LAYER                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │  REPOSITORIES   │    │  CONFIGURATION  │    │   BOT MAIN   │ │
│  ├─────────────────┤    ├─────────────────┤    ├──────────────┤ │
│  │ • GameRepoImpl  │    │ • Database      │    │ • Bot        │ │
│  │ • PlayerRepoImpl│    │   Config        │    │   Initialization│
│  │ • UserRepoImpl  │    │ • Game Config   │    │ • Handler    │ │
│  │ • EventRepoImpl │    │ • Bot Config    │    │   Registration│
│  │ • StatsRepoImpl │    │ • Logging       │    │ • Polling    │ │
│  │                 │    │   Config        │    │   Management │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Telegram  │───▶│  Bot Main   │───▶│  Handlers   │───▶│  Services   │
│     API     │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Database   │◀───│ Repositories│◀───│   Domain    │◀───│             │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## Взаимодействие компонентов

### 1. Обработка команды /join

```
User → Telegram → BotMain → CommandHandlers → BotService → GameService → GameRepository
                                                                    ↓
Database ← GameRepository ← GameService ← BotService ← CommandHandlers ← BotMain ← Telegram ← User
```

### 2. Обработка голосования

```
User → Telegram → BotMain → CallbackHandlers → BotService → VotingService → Game
                                                                    ↓
Game ← VotingService ← BotService ← CallbackHandlers ← BotMain ← Telegram ← User
```

### 3. Ночные действия

```
User → Telegram → BotMain → CallbackHandlers → BotService → RoleActions → Game
                                                                    ↓
Game ← RoleActions ← BotService ← CallbackHandlers ← BotMain ← Telegram ← User
```

## Принципы архитектуры

### 1. Dependency Inversion
- Высокоуровневые модули не зависят от низкоуровневых
- Оба зависят от абстракций
- Абстракции не зависят от деталей

### 2. Single Responsibility
- Каждый класс имеет одну причину для изменения
- Четкое разделение ответственности

### 3. Open/Closed Principle
- Открыт для расширения
- Закрыт для модификации

### 4. Interface Segregation
- Клиенты не должны зависеть от интерфейсов, которые они не используют

### 5. Liskov Substitution
- Объекты производных классов должны заменять объекты базовых классов

## Преимущества архитектуры

### ✅ Масштабируемость
- Легко добавлять новые функции
- Модульная структура
- Независимые компоненты

### ✅ Тестируемость
- Изолированные компоненты
- Мокирование зависимостей
- Unit и интеграционные тесты

### ✅ Поддерживаемость
- Четкая структура
- Понятный код
- Документация

### ✅ Гибкость
- Замена реализаций
- Конфигурируемость
- Адаптивность

## Заключение

Данная архитектура обеспечивает:

1. **Чистоту кода** - четкое разделение ответственности
2. **Гибкость** - легкое расширение и модификация
3. **Надежность** - валидация и обработка ошибок
4. **Производительность** - оптимизированные операции
5. **Тестируемость** - изолированные компоненты

Архитектура следует принципам SOLID и Clean Architecture, что делает код профессиональным, масштабируемым и готовым к дальнейшему развитию.
