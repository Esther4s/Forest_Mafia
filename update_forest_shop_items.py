#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ –õ–µ—Å–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É inventory
"""

import os
import sys
from database_psycopg2 import init_db, close_db

def update_forest_shop(database_url=None):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É inventory"""
    try:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DATABASE_URL –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω
        if database_url:
            os.environ['DATABASE_URL'] = database_url
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        db = init_db()
        
        with db.get_connection() as conn:
            with conn.cursor() as cursor:
                print("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
                
                # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É inventory –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                cursor.execute("""
                CREATE TABLE IF NOT EXISTS inventory (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    item_name VARCHAR(255) NOT NULL,
                    count INTEGER DEFAULT 1,
                    flags JSONB DEFAULT '{}'::jsonb,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(user_id, item_name)
                );
                """)
                
                # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                cursor.execute("""
                CREATE INDEX IF NOT EXISTS idx_inventory_user_id ON inventory(user_id);
                """)
                
                print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ inventory —Å–æ–∑–¥–∞–Ω–∞")
                
                # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã
                cursor.execute("DELETE FROM shop")
                print("üóëÔ∏è –°—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã —É–¥–∞–ª–µ–Ω—ã")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –õ–µ—Å–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
                forest_items = [
                    ('üé≠ –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–æ–ª—å', 1.00, '–ü–æ–≤—ã—à–∞–µ—Ç —à–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–æ–ª–∏ (–≤–æ–ª–∫, –ª–∏—Å–∞, –∫—Ä–æ—Ç, –±–æ–±—ë—Ä) –¥–æ 99%. –î–µ–π—Å—Ç–≤—É–µ—Ç –æ–¥–Ω—É –∏–≥—Ä—É.', 'boosts', True),
                    ('üåø –õ–µ—Å–Ω–∞—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞', 100.00, '–û–¥–∏–Ω —Ä–∞–∑ —Å–∫—Ä—ã–≤–∞–µ—Ç —Ä–æ–ª—å –∏–≥—Ä–æ–∫–∞ –æ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–æ—Ç–∞. –¢—Ä–∞—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ.', 'consumables', True),
                    ('üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –±–æ–±—Ä–∞', 150.00, '–°–ø–∞—Å–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –æ–¥–∏–Ω —Ä–∞–∑ –æ—Ç –∞—Ç–∞–∫–∏ –≤–æ–ª–∫–æ–≤. –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞—Ç–∞–∫–µ.', 'consumables', True),
                    ('üå∞ –ó–æ–ª–æ—Ç–æ–π –æ—Ä–µ—à–µ–∫', 200.00, '–£–¥–≤–∞–∏–≤–∞–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—Ä–µ—à–∫–∏ –∑–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–≥—Ä—É. –î–µ–π—Å—Ç–≤—É–µ—Ç –æ–¥–Ω—É –∏–≥—Ä—É.', 'boosts', True),
                    ('üåô –ù–æ—á–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ', 250.00, '–í –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ –∏–≥—Ä–æ–∫ –≤–∏–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥—Ä—É–≥–∏—Ö (–∫—Ç–æ –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–ª/–∞—Ç–∞–∫–æ–≤–∞–ª). –î–µ–π—Å—Ç–≤—É–µ—Ç –æ–¥–Ω—É –∏–≥—Ä—É.', 'consumables', True),
                    ('üîç –û—Å—Ç—Ä—ã–π –Ω—é—Ö', 300.00, '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–æ–ª–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏–≥—Ä–µ. –î–µ–π—Å—Ç–≤—É–µ—Ç –æ–¥–Ω—É –∏–≥—Ä—É.', 'boosts', True),
                    ('üçÑ –õ–µ—Å–Ω–æ–π —ç–ª–∏–∫—Å–∏—Ä', 400.00, '–í–æ—Å–∫—Ä–µ—à–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –æ–¥–∏–Ω —Ä–∞–∑, –µ—Å–ª–∏ –µ–≥–æ —É–±–∏–ª–∏. –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏.', 'consumables', True),
                    ('üå≤ –î—Ä–µ–≤–æ –∂–∏–∑–Ω–∏', 500.00, '–î–∞—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∂–∏–∑–Ω—å –Ω–∞ –≤—Å—é –∏–≥—Ä—É (—É–º–µ—Ä–µ—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–≤—É—Ö –∞—Ç–∞–∫). –î–µ–π—Å—Ç–≤—É–µ—Ç –≤—Å—é –∏–≥—Ä—É.', 'permanent', True)
                ]
                
                # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã
                insert_query = """
                INSERT INTO shop (item_name, price, description, category, is_active)
                VALUES (%s, %s, %s, %s, %s)
                """
                
                for item in forest_items:
                    cursor.execute(insert_query, item)
                    print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä: {item[0]} - {item[1]} –æ—Ä–µ—à–∫–æ–≤")
                
                # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                conn.commit()
                print("\nüéâ –õ–µ—Å–Ω–æ–π –º–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!")
                print("üì¶ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:", len(forest_items))
                print("üóÑÔ∏è –¢–∞–±–ª–∏—Ü–∞ inventory —Å–æ–∑–¥–∞–Ω–∞")
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞: {e}")
        import traceback
        traceback.print_exc()
        return False
    finally:
        close_db()
    
    return True

if __name__ == "__main__":
    print("üå≤ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –õ–µ—Å–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞...")
    print("=" * 50)
    
    # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å DATABASE_URL –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    database_url = None
    if len(sys.argv) > 1:
        database_url = sys.argv[1]
    elif os.environ.get('DATABASE_URL'):
        database_url = os.environ.get('DATABASE_URL')
    else:
        print("‚ùå DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python update_forest_shop_items.py <DATABASE_URL>")
        print("–ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL")
        sys.exit(1)
    
    success = update_forest_shop(database_url)
    
    if success:
        print("\n‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        print("üöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –õ–µ—Å–Ω–æ–π –º–∞–≥–∞–∑–∏–Ω!")
    else:
        print("\n‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–∞–º–∏!")
        sys.exit(1)
