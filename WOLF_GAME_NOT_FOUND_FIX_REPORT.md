# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ "–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" –¥–ª—è –≤–æ–ª–∫–∞

## –ü—Ä–æ–±–ª–µ–º–∞
–í–æ–ª–∫ –≤–∏–¥–µ–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞—Ö, –Ω–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–ª—É—á–∞–ª –æ—à–∏–±–∫—É "–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞". –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –º–µ—à–∞—é—â–∞—è –∏–≥—Ä–µ.

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
1. **–ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**: `night_actions` —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–æ–ª–µ–π –∏–≥—Ä–æ–∫–∞–º
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Ç–ª–∞–¥–∫–∏**: –ù–µ –±—ã–ª–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º –ø–æ–∏—Å–∫–∞ –∏–≥—Ä—ã
3. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ callback_handler**: –ú–µ—Ç–æ–¥ `_find_user_game` –º–æ–≥ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–≥—Ä—É

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (bot.py)
**–ü—Ä–æ–±–ª–µ–º–∞**: `night_actions` —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ø–æ—Å–ª–µ `send_roles_to_players`
**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ `night_actions` –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ä–æ–ª–µ–π

```python
# –°–æ–∑–¥–∞–µ–º night_actions –∏ night_interfaces –¥–ª—è –∏–≥—Ä—ã –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ä–æ–ª–µ–π
if game.chat_id not in self.night_actions:
    self.night_actions[game.chat_id] = NightActions(game)
if game.chat_id not in self.night_interfaces:
    self.night_interfaces[game.chat_id] = NightInterface(game, self.night_actions[game.chat_id], self.get_display_name)

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–ª–∏ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π
await self.send_roles_to_players(context, game)
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (callback_handler.py)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –±—ã–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, –ø–æ—á–µ–º—É –∏–≥—Ä–∞ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_find_user_game`

```python
def _find_user_game(self, user_id: int) -> Optional[Game]:
    """–ù–∞—Ö–æ–¥–∏—Ç –∏–≥—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
        from bot import ForestWolvesBot
        bot_instance = ForestWolvesBot.get_instance()
        
        if not bot_instance:
            self.logger.error(f"‚ùå –ë–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            return None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∏–≥—Ä–µ
        if user_id not in bot_instance.player_games:
            # –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ player_games, –∏—â–µ–º –ø–æ –≤—Å–µ–º –∏–≥—Ä–∞–º
            self.logger.info(f"üîç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ player_games, –∏—â–µ–º –ø–æ –≤—Å–µ–º –∏–≥—Ä–∞–º...")
            for chat_id, game in bot_instance.games.items():
                if user_id in game.players:
                    self.logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∏–≥—Ä–∞ {chat_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                    return game
            self.logger.warning(f"‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            return None
        
        # –ü–æ–ª—É—á–∞–µ–º chat_id –∏–≥—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        chat_id = bot_instance.player_games[user_id]
        self.logger.info(f"üîç –ò—â–µ–º –∏–≥—Ä—É {chat_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        game = bot_instance.games.get(chat_id)
        if game:
            self.logger.info(f"‚úÖ –ò–≥—Ä–∞ {chat_id} –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        else:
            self.logger.warning(f"‚ö†Ô∏è –ò–≥—Ä–∞ {chat_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ bot_instance.games")
        return game
        
    except Exception as e:
        self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        return None
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∏–≥—Ä–æ–∫–æ–≤ (bot.py)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –±—ã–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—É—á–∞—é—Ç –∏–≥—Ä–æ–∫–∏
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `send_roles_to_players`

```python
if game.chat_id in self.night_actions:
    night_actions = self.night_actions[game.chat_id]
    actions = night_actions.get_player_actions(player.user_id)
    logger.info(f"üîç –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∏–≥—Ä–æ–∫–∞ {player.user_id} ({player.role}): {actions}")
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ night_actions
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –í–æ–ª–∫ —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–≥—Ä—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

## –°—Ç–∞—Ç—É—Å
‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** - –û—à–∏–±–∫–∞ "–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" –¥–ª—è –≤–æ–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞
