# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–∞–ª–∏—Å—å, –≤–∫–ª—é—á–∞—è:
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
- –ù–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞

## –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –Ω–∞ –æ—á–∏—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö - –í–´–ü–û–õ–ù–ï–ù–û ‚úÖ

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –ú–µ—Ç–æ–¥ `clear_all_games()` –æ—á–∏—â–∞–ª –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
- –ú–µ—Ç–æ–¥ `_end_game_internal()` —É–¥–∞–ª—è–ª –∏–≥—Ä—ã –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ú–µ—Ç–æ–¥ `remove_channel()` –æ—á–∏—â–∞–ª –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è–ª–∏—Å—å

**–ú–µ—Å—Ç–∞ –æ—á–∏—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:**
```python
# bot.py - —Å—Ç—Ä–æ–∫–∏ 1862-1865
self.games.clear()
self.player_games.clear()
self.night_actions.clear()
self.night_interfaces.clear()

# bot.py - —Å—Ç—Ä–æ–∫–∏ 2151-2170
for pid in list(game.players.keys()):
    if pid in self.player_games:
        del self.player_games[pid]
# ... –∏ —Ç.–¥.
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–∏—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö - –í–´–ü–û–õ–ù–ï–ù–û ‚úÖ

**–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `state_persistence.py`:**
- –ö–ª–∞—Å—Å `StatePersistence` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –¢–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞
- –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö

**–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `auto_save_manager.py`:**
- –ö–ª–∞—Å—Å `AutoSaveManager` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –¶–∏–∫–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞

### 3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ë–î - –í–´–ü–û–õ–ù–ï–ù–û ‚úÖ

**–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î:**
```sql
-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
CREATE TABLE bot_state (
    id SERIAL PRIMARY KEY,
    state_type VARCHAR(50) NOT NULL,
    state_data JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(state_type)
);

-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
CREATE TABLE active_games_state (
    id SERIAL PRIMARY KEY,
    chat_id BIGINT NOT NULL,
    thread_id BIGINT,
    game_data JSONB NOT NULL,
    players_data JSONB NOT NULL,
    night_actions_data JSONB,
    night_interface_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(chat_id, thread_id)
);

-- –ú–∞–ø–ø–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤
CREATE TABLE player_games_state (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    chat_id BIGINT NOT NULL,
    thread_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

-- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
CREATE TABLE authorized_chats_state (
    id SERIAL PRIMARY KEY,
    chat_id BIGINT NOT NULL,
    thread_id BIGINT,
    chat_name VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(chat_id, thread_id)
);
```

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏:
1. **`state_persistence.py`** - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ë–î
2. **`auto_save_manager.py`** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
3. **`bot.py`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª**: –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- **–¢—Ä–∏–≥–≥–µ—Ä—ã**: –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **–§–æ—Ä–º–∞—Ç**: JSON –≤ PostgreSQL
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞

### –°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
- **–ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã**: –ü–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä
- **–ò–≥—Ä–æ–∫–∏**: –†–æ–ª–∏, –∫–æ–º–∞–Ω–¥—ã, —Å—Ç–∞—Ç—É—Å—ã, –ø—Ä–∏–ø–∞—Å—ã
- **–ù–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**: –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- **–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã**: –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞**: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- **`/save_state`** - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)
- **`/auto_save_status`** - –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- ‚ùå –ò–≥—Ä—ã –ø—Ä–µ—Ä—ã–≤–∞–ª–∏—Å—å
- ‚ùå –ò–≥—Ä–æ–∫–∏ —Ç–µ—Ä—è–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
- ‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ò–≥—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- ‚úÖ –ò–≥—Ä–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è `AutoSaveManager`
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ë–î
3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
4. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
5. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

### –í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:
1. –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ
2. –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ
3. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ
4. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON

### –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ:
1. –ë–æ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
2. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤
4. –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:
```bash
/save_state          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
/auto_save_status    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚ùå –û—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏
- ‚ÑπÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞. –¢–µ–ø–µ—Ä—å:

1. **–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
2. **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞** –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
3. **–ò–≥—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è** —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
4. **–ò–≥—Ä–æ–∫–∏ –Ω–µ —Ç–µ—Ä—è—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å** –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
5. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç: +100% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**
