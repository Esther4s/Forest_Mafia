# Диаграмма переходов между фазами игры

## 🔄 Полный цикл фаз игры

```
┌─────────────┐    start_night_phase()    ┌─────────────┐
│   WAITING   │ ────────────────────────► │    NIGHT    │
│   (Ожидание)│                           │   (Ночь)    │
└─────────────┘                           └─────────────┘
                                                │
                                                │ (60 сек)
                                                ▼
┌─────────────┐    start_day_phase()      ┌─────────────┐
│   VOTING    │ ◄──────────────────────── │     DAY     │
│ (Голосование)│                           │   (День)    │
└─────────────┘                           └─────────────┘
       ▲                                         │
       │                                         │ (5 мин)
       │                                         ▼
       │                                ┌─────────────┐
       │                                │   TIMER     │
       │                                │ (Таймер дня)│
       │                                └─────────────┘
       │                                         │
       │                                         │
       │ start_voting_phase()                    │
       │ (автоматически или досрочно)            │
       └─────────────────────────────────────────┘
```

## 📋 Детальное описание переходов

### 1. WAITING → NIGHT
- **Триггер**: `start_game()` → `start_night_phase()`
- **Действия**:
  - Распределение ролей
  - Отправка ролей игрокам в ЛС
  - Закрепление сообщения ночи
  - Запуск таймера ночи (60 секунд)

### 2. NIGHT → DAY
- **Триггер**: Завершение ночных действий (автоматически или досрочно)
- **Действия**:
  - Обработка ночных действий
  - Открепление сообщения ночи
  - Закрепление сообщения дня
  - Запуск таймера дня (5 минут)

### 3. DAY → VOTING
- **Триггеры**:
  - **Автоматически**: Истечение 5 минут (`day_phase_timer`)
  - **Досрочно**: Кнопка "🏁 Завершить обсуждение" (`day_end_discussion`)
- **Действия**:
  - Отмена таймера дня (если досрочно)
  - Открепление сообщения дня
  - Закрепление сообщения голосования
  - Отправка меню голосования в ЛС
  - Запуск таймера голосования (2 минуты)

### 4. VOTING → NIGHT
- **Триггеры**:
  - **Автоматически**: Истечение 2 минут (`voting_timer`)
  - **Досрочно**: Все игроки проголосовали
- **Действия**:
  - Обработка результатов голосования (`process_voting_results`)
  - Проверка условий окончания игры
  - Если игра продолжается: `start_new_night()` → `start_night_phase()`
  - Открепление сообщения голосования
  - Закрепление нового сообщения ночи

## 🔧 Досрочное завершение

### Досрочное завершение дня
```python
# Кнопка "🏁 Завершить обсуждение"
if query.data == "day_end_discussion":
    # Отменяем таймер дневной фазы
    game.cancel_day_timer()
    
    # Переходим к голосованию
    await self.start_voting_phase(mock_update, context, game)
```

### Досрочное завершение голосования
```python
# Все игроки проголосовали
if all_players_voted:
    await self.process_voting_results(update, context, game)
```

## 🎯 Ключевые особенности

### 1. Управление таймерами
- **Дневной таймер**: Сохраняется ссылка на задачу, может быть отменен
- **Ночной таймер**: Проверяет завершение всех ночных действий
- **Таймер голосования**: Проверяет, все ли игроки проголосовали

### 2. Закрепление сообщений
- Каждая фаза закрепляет свое сообщение
- При переходе к следующей фазе открепляется сообщение предыдущей
- При завершении игры открепляются все сообщения

### 3. Диагностика
- Кнопка "🔍 Диагностика таймера" во время дня
- Показывает статус таймера, время с начала фазы
- Помогает выяснить проблемы с таймером

## ✅ Проверенные сценарии

1. **Нормальный цикл**: Ночь → День → Голосование → Ночь
2. **Досрочное завершение дня**: Кнопка "Завершить обсуждение"
3. **Досрочное завершение голосования**: Все игроки проголосовали
4. **Отмена таймера**: При досрочном завершении или завершении игры
5. **Диагностика таймера**: Проверка статуса во время дня

## 🚀 Результат

Логика переходов между фазами работает корректно:
- ✅ После голосования действительно наступает ночь
- ✅ Досрочное завершение обсуждения работает правильно
- ✅ Таймеры корректно отменяются при досрочном завершении
- ✅ Закрепление сообщений работает для всех фаз
- ✅ Диагностика помогает выяснить проблемы с таймерами
