#!/usr/bin/env python3
"""
Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ inventory Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
"""

import os
import sys
from database_psycopg2 import init_db, close_db

def create_inventory_table():
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ inventory Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
    try:
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        db = init_db()
        
        with db.get_connection() as conn:
            with conn.cursor() as cursor:
                # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ inventory
                create_table_sql = """
                CREATE TABLE IF NOT EXISTS inventory (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    item_name VARCHAR(255) NOT NULL,
                    count INTEGER DEFAULT 1,
                    flags JSONB DEFAULT '{}'::jsonb,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
                    UNIQUE(user_id, item_name)
                );
                """
                
                print("ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ inventory...")
                cursor.execute(create_table_sql)
                print("âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° inventory ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!")
                
                # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ user_id
                create_index_sql = """
                CREATE INDEX IF NOT EXISTS idx_inventory_user_id ON inventory(user_id);
                """
                
                print("ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ user_id...")
                cursor.execute(create_index_sql)
                print("âœ… Ğ˜Ğ½Ğ´ĞµĞºÑ idx_inventory_user_id ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!")
                
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°
                check_table_sql = """
                SELECT EXISTS (
                    SELECT FROM information_schema.tables 
                    WHERE table_schema = 'public' 
                    AND table_name = 'inventory'
                );
                """
                
                cursor.execute(check_table_sql)
                exists = cursor.fetchone()[0]
                
                if exists:
                    print("âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° inventory ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!")
                else:
                    print("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° inventory Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!")
                    return False
                
                # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
                describe_sql = """
                SELECT column_name, data_type, is_nullable, column_default
                FROM information_schema.columns 
                WHERE table_name = 'inventory' 
                ORDER BY ordinal_position;
                """
                
                cursor.execute(describe_sql)
                columns = cursor.fetchall()
                
                print("\nğŸ“‹ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ inventory:")
                print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
                print("â”‚ Column Name â”‚ Data Type   â”‚ Nullable    â”‚ Default         â”‚")
                print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
                for col in columns:
                    col_name, data_type, nullable, default = col
                    default_str = str(default) if default else "NULL"
                    print(f"â”‚ {col_name:<11} â”‚ {data_type:<11} â”‚ {nullable:<11} â”‚ {default_str:<15} â”‚")
                print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
                
                return True
                
    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ inventory: {e}")
        return False
    finally:
        # Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
        close_db()

def main():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ"""
    print("ğŸš€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ inventory Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")
    print("=" * 50)
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ DATABASE_URL
    database_url = os.getenv('DATABASE_URL')
    
    # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°, Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
    if not database_url:
        try:
            with open('env_local.txt', 'r') as f:
                for line in f:
                    if line.startswith('DATABASE_URL='):
                        database_url = line.strip().split('=', 1)[1]
                        os.environ['DATABASE_URL'] = database_url
                        break
        except FileNotFoundError:
            pass
    
    if not database_url:
        print("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ DATABASE_URL Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!")
        print("ğŸ’¡ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ DATABASE_URL Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°")
        return False
    
    print(f"ğŸ”— ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")
    print(f"ğŸ“Š DATABASE_URL: {os.getenv('DATABASE_URL')[:20]}...")
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
    success = create_inventory_table()
    
    if success:
        print("\nğŸ‰ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ! Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° inventory ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!")
        print("âœ… Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ±ÑƒĞ´ÑƒÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾")
        return True
    else:
        print("\nâŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ! ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ inventory")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
