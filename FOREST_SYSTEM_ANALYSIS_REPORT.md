# üå≤ –û–¢–ß–ï–¢ –û –°–ò–°–¢–ï–ú–ï –õ–ï–°–û–í

## üìã –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –ª–µ—Å–æ–≤

–°–∏—Å—Ç–µ–º–∞ –ª–µ—Å–æ–≤ - —ç—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–∞ "–õ–µ—Å –∏ –í–æ–ª–∫–∏", –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –°–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–ª–µ—Å–∞)
- –£–ø—Ä–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –ª–µ—Å–æ–≤
- –°–æ–∑—ã–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∏–≥—Ä—ã
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
- –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø—Ä–æ—Ñ–∏–ª–∏ –ª–µ—Å–æ–≤

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **–û—à–∏–±–∫–∏ –≤ `forest_system.py`**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `forest_id`
```python
# ‚ùå –ë—ã–ª–æ:
forest_id=forest_id,  # forest_id –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
forest_id=forest.id,  # –∏—Å–ø–æ–ª—å–∑—É–µ–º forest.id
```

### 2. **–û—à–∏–±–∫–∏ –≤ `forest_handlers.py`**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ID –ª–µ—Å–∞ (—Å—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞)
```python
# ‚ùå –ë—ã–ª–æ:
forest_id = command.replace('/leave_forest_', '')
success = await self.forest_manager.leave_forest(forest_id, user.id)

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
forest_id_str = command.replace('/leave_forest_', '')
forest_id = int(forest_id_str)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ
success = await self.forest_manager.leave_forest(forest_id, user.id)
```

### 3. **–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª–∏ `ForestMember`**
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ª–µ—Å–∞
```python
# ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ:
class ForestMember(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    username = Column(String(100), nullable=True)
    first_name = Column(String(100), nullable=True)
    is_opt_in = Column(Boolean, default=True)  # –ü–æ–ª—É—á–∞–µ—Ç –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

### 4. **–û—à–∏–±–∫–∏ –≤ `forest_integration.py`**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
```python
# ‚ùå –ë—ã–ª–æ:
temp_context.args = [forest_id]  # forest_id –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
temp_context.args = [forest_id_str]  # –ø–µ—Ä–µ–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É
```

## üõ†Ô∏è –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ `forest_system.py`**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `forest.id` –≤–º–µ—Å—Ç–æ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º ID –ª–µ—Å–∞

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ `forest_handlers.py`**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ ID –≤ —á–∏—Å–ª–æ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ `ValueError` –¥–ª—è –Ω–µ–≤–µ—Ä–Ω—ã—Ö ID
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ `database.py`**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `username`, `first_name`, `is_opt_in` –≤ –º–æ–¥–µ–ª—å `ForestMember`

### 4. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ `database_psycopg2.py`**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–µ–π `forest_members`:
  - `username VARCHAR(100)`
  - `first_name VARCHAR(100)`
  - `is_opt_in BOOLEAN DEFAULT true`

### 5. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ `forest_integration.py`**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ID –ª–µ—Å–∞

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ª–µ—Å–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **`forest_system.py`** - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ª–µ—Å–æ–≤
   - `ForestManager` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ—Å–∞–º–∏
   - `ForestConfig` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–µ—Å–∞
   - `ForestPrivacy` - —Ç–∏–ø—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

2. **`forest_handlers.py`** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
   - `ForestCommandHandlers` - –∫–æ–º–∞–Ω–¥—ã –ª–µ—Å–æ–≤
   - `ForestCallbackHandlers` - callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

3. **`forest_integration.py`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º
   - `ForestIntegration` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

4. **`database.py`** - –ú–æ–¥–µ–ª–∏ –ë–î
   - `Forest` - –º–æ–¥–µ–ª—å –ª–µ—Å–∞
   - `ForestMember` - —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ª–µ—Å–∞
   - `ForestInvite` - –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
   - `ForestSetting` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–µ—Å–∞

## üéØ –ö–æ–º–∞–Ω–¥—ã —Å–∏—Å—Ç–µ–º—ã –ª–µ—Å–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `/create_forest <–Ω–∞–∑–≤–∞–Ω–∏–µ> <–æ–ø–∏—Å–∞–Ω–∏–µ>` - —Å–æ–∑–¥–∞—Ç—å –ª–µ—Å
- `/forests` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ª–µ—Å–æ–≤
- `/my_forests` - –º–æ–∏ –ª–µ—Å–∞

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã:
- `/join_forest_<id>` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–µ—Å—É
- `/leave_forest_<id>` - –ø–æ–∫–∏–Ω—É—Ç—å –ª–µ—Å
- `/list_forest_<id>` - —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ª–µ—Å–∞
- `/summon_forest_<id>` - —Å–æ–∑–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ª–µ—Å–∞
- `/invite_forest_<id> @username` - –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –ª–µ—Å

### Callback –∫–æ–º–∞–Ω–¥—ã:
- `join_forest_<id>` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
- `forest_info_<id>` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–µ—Å–µ
- `accept_invite_<id>` - –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
- `decline_invite_<id>` - –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_forest_system.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏—è –ª–µ—Å–∞
- ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–µ—Å—É
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ª–µ—Å–∞
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–µ—Å–µ
- ‚úÖ –ü–æ–∫–∏–¥–∞–Ω–∏—è –ª–µ—Å–∞
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## üìà –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –ª–µ—Å–æ–≤

### 1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ—Å–∞–º–∏**
- –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ª–µ—Å–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ª–µ—Å–∞

### 2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏**
- –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ/–ø–æ–∫–∏–¥–∞–Ω–∏–µ –ª–µ—Å–∞
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (opt-in/opt-out)

### 3. **–°–æ–∑—ã–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤**
- –ë–∞—Ç—á–µ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- Cooldown –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞

### 4. **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è**
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
- –ü—Ä–∏–Ω—è—Ç–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π

### 5. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ª–µ—Å–∞
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –¢–æ–ø –ª–µ—Å–æ–≤

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –±–æ—Ç–æ–º

–°–∏—Å—Ç–µ–º–∞ –ª–µ—Å–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –±–æ—Ç–æ–º —á–µ—Ä–µ–∑:
1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** - `init_forest_integration()`
2. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥** - `get_command_handlers()`
3. **Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - `get_callback_handlers()`
4. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã** - `get_dynamic_command_handlers()`

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–∞ –ª–µ—Å–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞:
- ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
2. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –±–æ—Ç–æ–º** –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ
3. **–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. **–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–°–∏—Å—Ç–µ–º–∞ –ª–µ—Å–æ–≤ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üå≤‚ú®
