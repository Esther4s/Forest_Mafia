# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö –ë–û–¢–ê

## üéØ **–ü–†–û–ë–õ–ï–ú–´ –ò–ó –õ–û–ì–û–í**

–ò–∑ –ª–æ–≥–æ–≤ –±–æ—Ç–∞ –±—ã–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:

1. **‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: integer out of range**
2. **‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤: name 'get_connection' is not defined**
3. **‚ùå –û—à–∏–±–∫–∞ –≤ handle_start_game_callback: 'Player' object has no attribute 'first_name'**
4. **‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ—á–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è: 'GamePhaseManager' object has no attribute '_handle_waiting_to_night'**

---

## ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ "integer out of range"**

**–ü—Ä–æ–±–ª–µ–º–∞:** Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–µ–≤—ã—à–∞—é—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ INTEGER –≤ PostgreSQL.

**–†–µ—à–µ–Ω–∏–µ:** –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞–Ω–µ–µ (—Å–æ–≥–ª–∞—Å–Ω–æ `INTEGER_OUT_OF_RANGE_FIX_REPORT.md`), –Ω–æ –æ—à–∏–±–∫–∞ –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –∏–∑-–∑–∞ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (—Å—Ö–µ–º–∞ –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞)

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ "name 'get_connection' is not defined"**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö `database_psycopg2.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `get_connection()` –≤–º–µ—Å—Ç–æ `db_connection.get_connection()`.

**–§–∞–π–ª:** `database_psycopg2.py`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
with get_connection() as conn:

# –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
with db_connection.get_connection() as conn:
```

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `add_active_effect()`
- `get_active_effects()`
- `remove_active_effect()`
- `get_user_active_effects()`
- `cleanup_expired_effects()`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### **3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ "'Player' object has no attribute 'first_name'"**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∞—Å—Å `Player` –≤ `game_logic.py` –Ω–µ –∏–º–µ–ª –ø–æ–ª–µ–π `first_name` –∏ `last_name`.

**–§–∞–π–ª:** `game_logic.py`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
@dataclass
class Player:
    """–ò–≥—Ä–æ–∫ –≤ –∏–≥—Ä–µ –õ–µ—Å –∏ –≤–æ–ª–∫–∏"""
    user_id: int
    username: str
    first_name: str = None          # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    last_name: str = None           # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    role: Role = None               # ‚úÖ –°–¥–µ–ª–∞–Ω–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
    team: Team = None               # ‚úÖ –°–¥–µ–ª–∞–Ω–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
    is_alive: bool = True
    supplies: int = 2
    max_supplies: int = 2
    is_fox_stolen: int = 0
    stolen_supplies: int = 0
    is_beaver_protected: bool = False
    consecutive_nights_survived: int = 0
    last_action_round: int = 0
    extra_lives: int = 0
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### **4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ "'GamePhaseManager' object has no attribute '_handle_waiting_to_night'"**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–ª–∞—Å—Å–µ `GamePhaseManager` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –º–µ—Ç–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –∏–≥—Ä—ã.

**–§–∞–π–ª:** `game_phase_manager.py`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def _handle_waiting_to_night(self, game: Game, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∫ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ"""

async def _handle_night_to_day(self, game: Game, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç –Ω–æ—á–∏ –∫ –¥–Ω—é"""

async def _handle_day_to_voting(self, game: Game, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç –¥–Ω—è –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é"""

async def _handle_voting_to_night(self, game: Game, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∫ –Ω–æ—á–∏"""

async def _handle_game_over(self, game: Game, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã"""
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–∑ –∏–≥—Ä—ã
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –≤ –ë–î
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üéØ **–û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´**

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

**–í–º–µ—Å—Ç–æ –æ—à–∏–±–æ–∫:**
```
ERROR:database_psycopg2:‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: integer out of range
ERROR:database_psycopg2:‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤: name 'get_connection' is not defined
ERROR:__main__:‚ùå –û—à–∏–±–∫–∞ –≤ handle_start_game_callback: 'Player' object has no attribute 'first_name'
ERROR:__main__:‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ—á–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è: 'GamePhaseManager' object has no attribute '_handle_waiting_to_night'
```

**–ë—É–¥–µ—Ç —É—Å–ø–µ—à–Ω–∞—è —Ä–∞–±–æ—Ç–∞:**
```
INFO:database_psycopg2:‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 8455370841
INFO:__main__:‚úÖ –ò–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ —á–µ—Ä–µ–∑ callback
INFO:__main__:‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ—á–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
INFO:game_phase_manager:üåô –ò–≥—Ä–∞ -1002785929250 –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ –Ω–æ—á–Ω—É—é —Ñ–∞–∑—É (—Ä–∞—É–Ω–¥ 1)
```

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

- üéØ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
- üîí –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- üöÄ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –∏–≥—Ä—ã
- üìä –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
- üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

---

## üìã **–ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô**

### **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ–ª—å—à–∏–º–∏ Telegram ID
2. **–ò–≥—Ä–æ–∫–∏:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ —Å first_name/last_name
3. **–§–∞–∑—ã –∏–≥—Ä—ã:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏
4. **–ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

–°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—à–∏–±–æ–∫ "integer out of range"
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—à–∏–±–æ–∫ "name 'get_connection' is not defined"
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—à–∏–±–æ–∫ —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ Player
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—à–∏–±–æ–∫ —Å –º–µ—Ç–æ–¥–∞–º–∏ GamePhaseManager

---

## üéâ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

- ‚úÖ **4/4 –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**
- ‚úÖ **0 –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞**
- ‚úÖ **–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**

–ë–æ—Ç –¥–æ–ª–∂–µ–Ω —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫.
