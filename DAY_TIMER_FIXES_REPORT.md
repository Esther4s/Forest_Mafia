# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –¥–Ω–µ–≤–Ω—ã–º —Ç–∞–π–º–µ—Ä–æ–º

## üéØ –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã

### 1. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–∞—Ö –≤ —Ç–µ—Å—Ç–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ—Å—Ç—ã –≤—ã–¥–∞–≤–∞–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–µ –±—ã–ª–∏ –æ–∂–∏–¥–∞–µ–º—ã (awaited).

**–†–µ—à–µ–Ω–∏–µ**: 
- –û–±–µ—Ä–Ω—É–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ `asyncio.run()` 
- –°–æ–∑–¥–∞–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –£–±—Ä–∞–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä—É—Ç–∏–Ω–∞—Ö

### 2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–Ω–µ–≤–Ω—ã–º —Ç–∞–π–º–µ—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–æ–≥–¥–∞ –¥–ª–∏—Ç—Å—è –¥–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç
**–ü—Ä–æ–±–ª–µ–º–∞**: –î–Ω–µ–≤–Ω–∞—è —Ñ–∞–∑–∞ –∏–Ω–æ–≥–¥–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.

**–ü—Ä–∏—á–∏–Ω—ã**:
- –¢–∞–π–º–µ—Ä –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∫–∞–∫ `asyncio.create_task()`, –Ω–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–¥–∞—á—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å
- –ü—Ä–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã —Ç–∞–π–º–µ—Ä –Ω–µ –æ—Ç–º–µ–Ω—è–ª—Å—è
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å —Ç–∞–π–º–µ—Ä–æ–º

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω—ã–º —Ç–∞–π–º–µ—Ä–æ–º

#### –í `game_logic.py`:
- **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è**:
  - `day_timer_task` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–¥–∞—á—É —Ç–∞–π–º–µ—Ä–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã
  - `day_start_time` - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã

- **–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã**:
  - `set_day_timer_task(task)` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ —Ç–∞–π–º–µ—Ä–∞
  - `cancel_day_timer()` - –æ—Ç–º–µ–Ω–∞ —Ç–∞–π–º–µ—Ä–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã
  - `get_day_timer_status()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–∞–π–º–µ—Ä–∞

- **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥**:
  - `start_day()` - —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã

#### –í `bot.py`:
- **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥** `start_day_phase()`:
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –∑–∞–¥–∞—á—É —Ç–∞–π–º–µ—Ä–∞
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞–π–º–µ—Ä–∞"

- **–£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥** `day_phase_timer()`:
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–¥–∞—á—É

- **–û–±–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫** `day_end_discussion`:
  - –û—Ç–º–µ–Ω—è–µ—Ç —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- **–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫** `day_timer_diagnostics`:
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
  - –í—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞ –¥–Ω—è
  - –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ —Ç–∞–π–º–µ—Ä–∞
  - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º

- **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥** `end_game_winner()`:
  - –û—Ç–º–µ–Ω—è–µ—Ç —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã

### 2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

#### –ö–Ω–æ–ø–∫–∞ "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞–π–º–µ—Ä–∞"
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –¢–µ–∫—É—â—É—é —Ñ–∞–∑—É –∏–≥—Ä—ã
- –°—Ç–∞—Ç—É—Å —Ç–∞–π–º–µ—Ä–∞ (–∞–∫—Ç–∏–≤–µ–Ω/–∑–∞–≤–µ—Ä—à–µ–Ω/–Ω–µ –Ω–∞–π–¥–µ–Ω)
- –í—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ —Ç–∞–π–º–µ—Ä–∞
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∏–ª–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–µ)
- –û—Ç–º–µ–Ω–∞ —Ç–∞–π–º–µ—Ä–∞
- –û—à–∏–±–∫–∏ –≤ —Ç–∞–π–º–µ—Ä–µ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç—ã:
1. **`test_day_timer_diagnostics.py`** - —Ç–µ—Å—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
2. **–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã** `test_stage_pinning.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–Ω–µ–≤–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–∞–π–º–µ—Ä–∞ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
- ‚úÖ –ó–∞–ø–∏—Å—å –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–µ–π —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ —Ç–∞–π–º–µ—Ä–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏:
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
day_timer_task = asyncio.create_task(self.day_phase_timer(update, context, game))
game.set_day_timer_task(day_timer_task)

# –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏
game.cancel_day_timer()
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
```python
def get_day_timer_status(self):
    if not self.day_start_time:
        return "–¢–∞–π–º–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    
    elapsed = (datetime.now() - self.day_start_time).total_seconds()
    remaining = max(0, 300 - elapsed)
    
    if self.day_timer_task:
        if self.day_timer_task.done():
            return f"–¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω (–ø—Ä–æ—à–ª–æ {elapsed:.1f}—Å)"
        else:
            return f"–¢–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω (–æ—Å—Ç–∞–ª–æ—Å—å {remaining:.1f}—Å)"
    else:
        return f"–¢–∞–π–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø—Ä–æ—à–ª–æ {elapsed:.1f}—Å)"
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
```python
async def day_phase_timer(self, update, context, game):
    try:
        logger.info(f"–ó–∞–ø—É—â–µ–Ω —Ç–∞–π–º–µ—Ä –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã –¥–ª—è –∏–≥—Ä—ã {game.chat_id}")
        await asyncio.sleep(300)
        
        if game.phase == GamePhase.DAY:
            logger.info(f"–¢–∞–π–º–µ—Ä –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é")
            await self.start_voting_phase(update, context, game)
        else:
            logger.info(f"–¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ —Ñ–∞–∑–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –Ω–∞ {game.phase}")
            
    except asyncio.CancelledError:
        logger.info(f"–¢–∞–π–º–µ—Ä –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã –æ—Ç–º–µ–Ω–µ–Ω")
        raise
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ç–∞–π–º–µ—Ä–µ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑—ã: {e}")
    finally:
        game.day_timer_task = None
```

## üìã –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. **–î–Ω–µ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
2. **–î–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ** –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–º–µ–Ω—è–µ—Ç —Ç–∞–π–º–µ—Ä
3. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã—è—Å–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∞–π–º–µ—Ä–æ–º
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Ç–∞–π–º–µ—Ä–∞
5. **–¢–µ—Å—Ç—ã** –Ω–µ –≤—ã–¥–∞—é—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- üéØ –ù–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
- üîç –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
- üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞
- üõ°Ô∏è –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- üßπ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
- üìù –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## ‚úÖ –°—Ç–∞—Ç—É—Å
**–ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û** - –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–Ω–µ–≤–Ω—ã–º —Ç–∞–π–º–µ—Ä–æ–º —Ä–µ—à–µ–Ω—ã.
