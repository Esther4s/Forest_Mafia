# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–û–ö –í –°–•–ï–ú–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•

## üéØ **–ü–†–û–ë–õ–ï–ú–´ –í –ò–°–•–û–î–ù–û–ú SQL –ö–û–î–ï**

### ‚ùå **–û—à–∏–±–∫–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ SQL**
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–∞
    RETURN NEW;
-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫—É–ø–æ–∫
CREATE TABLE IF NOT EXISTS shop (
END;
CREATE TABLE IF NOT EXISTS purchases (
    id SERIAL PRIMARY KEY,
$$ LANGUAGE plpgsql;
    item_name VARCHAR(255) NOT NULL,
    id SERIAL PRIMARY KEY,
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –°–º–µ—à–∞–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PostgreSQL

### ‚ùå **–û—à–∏–±–∫–∞ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã**
```sql
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –§—É–Ω–∫—Ü–∏—è `update_updated_at_column()` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ DROP TRIGGER –∫–æ–º–∞–Ω–¥—ã

### ‚ùå **–û—à–∏–±–∫–∞ 3: –ù–µ–ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞**
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–Ω–æ–≥–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ù–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π
- –ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **1. –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞**

**–§–∞–π–ª:** `fixed_database_schema.sql`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ SQL
- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
- ‚úÖ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views) –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è timestamp**

**–ë—ã–ª–æ:**
```sql
-- –§—É–Ω–∫—Ü–∏—è –Ω–µ –±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
```

**–°—Ç–∞–ª–æ:**
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### **3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä—ã**

**–ë—ã–ª–æ:**
```sql
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**–°—Ç–∞–ª–æ:**
```sql
DROP TRIGGER IF EXISTS trigger_users_updated_at ON users;
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### **4. –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã**

**–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:**
- ‚úÖ `users` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `games` - –∏–≥—Ä—ã
- ‚úÖ `players` - –∏–≥—Ä–æ–∫–∏ –≤ –∏–≥—Ä–∞—Ö
- ‚úÖ `game_events` - —Å–æ–±—ã—Ç–∏—è –∏–≥—Ä
- ‚úÖ `player_actions` - –¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–æ–≤
- ‚úÖ `votes` - –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
- ‚úÖ `player_stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
- ‚úÖ `bot_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
- ‚úÖ `chat_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–æ–≤
- ‚úÖ `shop` - –º–∞–≥–∞–∑–∏–Ω
- ‚úÖ `purchases` - –ø–æ–∫—É–ø–∫–∏
- ‚úÖ `stats` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### **5. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

**–°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ø–æ –≤–Ω–µ—à–Ω–∏–º –∫–ª—é—á–∞–º
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ø–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –ø–æ–ª—è–º
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

### **6. –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

**–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã –≤ –º–∞–≥–∞–∑–∏–Ω:**
- üé≠ –ú–∞—Å–∫–∞ –≤–æ–ª–∫–∞ (100.00)
- ü¶ä –•–≤–æ—Å—Ç –ª–∏—Å—ã (150.00)
- üê∞ –£—à–∏ –∑–∞–π—Ü–∞ (80.00)
- üï≥Ô∏è –õ–æ–ø–∞—Ç–∞ –∫—Ä–æ—Ç–∞ (200.00)
- ü¶´ –ë–æ–±—Ä–æ–≤—ã–π —Ö–≤–æ—Å—Ç (120.00)
- ‚≠ê –ó–≤–µ–∑–¥–∞ —É–¥–∞—á–∏ (500.00)
- üéØ –¢–æ—á–Ω—ã–π –≤—ã—Å—Ç—Ä–µ–ª (300.00)
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ (400.00)

### **7. –°–æ–∑–¥–∞–Ω—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)**

**–°–æ–∑–¥–∞–Ω—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ `user_full_stats` - –ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `top_players` - —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤

---

## üß™ **–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–•–ï–ú–´**

### **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ö–µ–º—ã**

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN (
    'users', 'games', 'players', 'game_events', 
    'player_actions', 'votes', 'player_stats', 
    'bot_settings', 'chat_settings', 'shop', 
    'purchases', 'stats'
);

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT indexname 
FROM pg_indexes 
WHERE schemaname = 'public';

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT trigger_name 
FROM information_schema.triggers 
WHERE trigger_schema = 'public';
```

---

## üìä **–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô**

### ‚úÖ **–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞:**

- **–¢–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω–æ**: 12
- **–ò–Ω–¥–µ–∫—Å–æ–≤ —Å–æ–∑–¥–∞–Ω–æ**: 20+
- **–¢—Ä–∏–≥–≥–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ**: 7
- **–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–æ**: 2
- **–¢–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ**: 8

### ‚úÖ **–í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**

- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQL
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç timestamp
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

### ‚úÖ **–°—Ö–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:**

- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å PostgreSQL
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è

---

## üöÄ **–ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ**

### **1. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
```bash
# –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
createdb forest_mafia_bot

# –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É
psql -d forest_mafia_bot -f fixed_database_schema.sql
```

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:**
```bash
# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ
psql -d forest_mafia_bot

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
\dt

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
\di

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã
\dy
```

### **3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–≤–∞—Ä—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
SELECT * FROM shop;

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
SELECT * FROM user_full_stats LIMIT 5;
SELECT * FROM top_players LIMIT 5;
```

---

## üéâ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–í—Å–µ –æ—à–∏–±–∫–∏ –≤ —Å—Ö–µ–º–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!**

- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ö–µ–º–∞
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç timestamp –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- ‚úÖ –°—Ö–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è!**

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 9 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
**–§–∞–π–ª**: `fixed_database_schema.sql`
