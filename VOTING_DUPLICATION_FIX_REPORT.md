# üó≥Ô∏è –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ `complete_exile_voting_early`, –∫–æ—Ç–æ—Ä–∞—è –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –≤—ã–∑—ã–≤–∞–µ—Ç `process_voting_results`.

---

## üîç **–ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´**

### **–ú–µ—Å—Ç–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**

1. **–í —Ç–∞–π–º–µ—Ä–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** (`voting_timer`)
   - –°—Ç—Ä–æ–∫–∞ 1716: `asyncio.create_task(self.complete_exile_voting_early(context, game))`

2. **–í callback –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** (`handle_voting`)
   - –°—Ç—Ä–æ–∫–∞ 1994: `asyncio.create_task(self.complete_exile_voting_early(context, game))`

3. **–í callback –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏** (`handle_voting`)
   - –°—Ç—Ä–æ–∫–∞ 2019: `asyncio.create_task(self.complete_exile_voting_early(context, game))`

### **–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–≥–¥–∞ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏, –º–æ–≥–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å:
- –¢–∞–π–º–µ—Ä –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
- Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–ø—Ä–∏ –∫–∞–∂–¥–æ–º –≥–æ–ª–æ—Å–µ)

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–¥–∞—á** `complete_exile_voting_early`, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã–∑—ã–≤–∞–ª–∞ `process_voting_results`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

---

## ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **1. –£–ª—É—á—à–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –≤ `complete_exile_voting_early`:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –≤—ã–∑–≤–∞–Ω —ç—Ç–æ—Ç –º–µ—Ç–æ–¥
if hasattr(game, 'exile_voting_completed') and game.exile_voting_completed:
    logger.info("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∏–∑–≥–Ω–∞–Ω–∏–µ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
    return

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
if game.phase != GamePhase.VOTING or not hasattr(game, 'voting_type') or game.voting_type != "exile":
    logger.info(f"–ò–≥—Ä–∞ –Ω–µ –≤ —Ñ–∞–∑–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –∏–∑–≥–Ω–∞–Ω–∏–µ: phase={game.phase}, voting_type={getattr(game, 'voting_type', 'None')}")
    return

game.exile_voting_completed = True  # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ
```

### **2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –≤ —Ç–∞–π–º–µ—Ä –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –∏–∑–≥–Ω–∞–Ω–∏–µ
if game.voting_type == "exile" and current_votes >= expected_voters:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
    if not (hasattr(game, 'exile_voting_completed') and game.exile_voting_completed):
        logger.info("–í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏! –ó–∞–≤–µ—Ä—à–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ä–æ—á–Ω–æ.")
        asyncio.create_task(self.complete_exile_voting_early(context, game))
    return
```

### **3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –≤ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏
if hasattr(game, 'total_voters') and hasattr(game, 'voting_type') and game.voting_type == "exile":
    if len(game.votes) >= game.total_voters:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
        if not (hasattr(game, 'exile_voting_completed') and game.exile_voting_completed):
            # –í—Å–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ - –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–æ—Å—Ä–æ—á–Ω–æ
            asyncio.create_task(self.complete_exile_voting_early(context, game))
```

### **4. –û—á–∏—Å—Ç–∫–∞ —Ñ–ª–∞–≥–æ–≤ –≤ –∫–æ–Ω—Ü–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```python
# –û—á–∏—â–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
if hasattr(game, 'total_voters'):
    delattr(game, 'total_voters')
if hasattr(game, 'voting_type'):
    delattr(game, 'voting_type')
if hasattr(game, 'voting_results_processed'):
    delattr(game, 'voting_results_processed')
if hasattr(game, 'exile_voting_completed'):  # –ù–û–í–û–ï
    delattr(game, 'exile_voting_completed')
```

---

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò**

### **–ú–µ—Ö–∞–Ω–∏–∑–º –∑–∞—â–∏—Ç—ã:**
1. **–§–ª–∞–≥ `exile_voting_completed`** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∑—ã –∏–≥—Ä—ã** - —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–≥—Ä–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ–∞–∑–µ
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** - —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –∏–∑–≥–Ω–∞–Ω–∏–µ
4. **–û—á–∏—Å—Ç–∫–∞ —Ñ–ª–∞–≥–æ–≤** - —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### **–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
1. –ò–≥—Ä–æ–∫ –≥–æ–ª–æ—Å—É–µ—Ç ‚Üí callback –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤
2. –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ `complete_exile_voting_early`
3. –¢–∞–π–º–µ—Ä —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É, –Ω–æ –∑–∞—â–∏—Ç–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
4. `complete_exile_voting_early` –≤—ã–∑—ã–≤–∞–µ—Ç `process_voting_results`
5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**
6. –§–ª–∞–≥–∏ –æ—á–∏—â–∞—é—Ç—Å—è

---

## ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:**
- ‚úÖ **–ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã** - –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ **–õ–∏–Ω—Ç–µ—Ä** - –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
- ‚úÖ **–õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é

### **–£—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚ùå **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ
- ‚ùå **Race conditions** - —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã

---

## üéØ **–ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢**

### **‚úÖ –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ì–û–õ–û–°–û–í–ê–ù–ò–Ø –£–°–¢–†–ê–ù–ï–ù–û**

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –º–µ—Å—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**

- üó≥Ô∏è **–¢–∞–π–º–µ—Ä –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** - –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- üîò **Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ö° **–î–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- üßπ **–û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –≤—Å–µ —Ñ–ª–∞–≥–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è

**–°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!** üó≥Ô∏è‚úÖ
